trigger:
- master

pool:
  vmImage: 'ubuntu-20.04'

######Job Details#####
name: $(SourceBranchName)_$(Date:yyyyMMdd)_$(Rev:rr)

steps:
- task: CmdLine@2
  inputs:
    script: 'docker run -u zap -p 7777:7777 --name ZAPTEST -i -d owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0 -port 7777 -config api.disablekey=true -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true'
  displayName: Run ZAP Docker Container
  
- task: Maven@3
  inputs:
    mavenPomFile: './smartHub-bdd/pom.xml'
    goals: 'clean verify -PdontUseTheForks'
    options: '-DappConfig=$(APPCONFIGPROPERTIES) -Dserenity.proxy.http="localhost" -Dserenity.proxy.http_port="7777" -Dcucumber.filter.tags="@sanity" -Dcucumber.features="src/test/resources/features"'
    publishJUnitResults: true
    testResultsFiles: './smartHub-bdd/target/site/serenity/'
    testRunTitle: 'Smart Tests'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.11'
    mavenVersionOption: 'Default'
    mavenAuthenticateFeed: false
    effectivePomSkip: false
    sonarQubeRunAnalysis: false
  continueOnError: true
  displayName: Run Automated Tests with -> [ $(APPCONFIGPROPERTIES)]

######################### Test purpose task #####################
#- task: CmdLine@2
#  inputs:
#   script: 'docker exec ZAPTEST zap-api-scan.py -t http://localhost:7777/JSON/core/view/sites/ -f openapi'
#    script: 'curl -v GET $(CURLCMD)'
#  condition: always()
#  continueOnError: true
# displayName: Executing ZAP API commands using cURL

- task: Bash@3
  inputs:
    targetType: 'inline'
    script:
      a=$(curl --trace - --trace-time -v -i GET $(CURLCMD)) && echo $a
  condition: always()
  continueOnError: true
  displayName: Executing cURL ZAP API calls